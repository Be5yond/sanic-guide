(window.webpackJsonp=window.webpackJsonp||[]).push([[59],{390:function(t,e,s){"use strict";s.r(e);var a=s(5),n=Object(a.a)({},(function(){var t=this,e=t._self._c;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("h1",{attrs:{id:"worker-manager"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#worker-manager"}},[t._v("#")]),t._v(" Worker Manager")]),t._v(" "),e("p",[t._v("The worker manager and its functionality was introduced in version 22.9.")]),t._v(" "),e("p",[e("em",[t._v("The details of this section are intended for more advanced usages and "),e("strong",[t._v("not")]),t._v(" necessary to get started.")])]),t._v(" "),e("p",[t._v("The purpose of the manager is to create consistency and flexibility between development and production environments. Whether you intend to run a single worker, or multiple workers, whether with, or without auto-reload: the experience will be the same.")]),t._v(" "),e("p",[t._v("In general it looks like this:")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://user-images.githubusercontent.com/166269/178677618-3b4089c3-6c6a-4ecc-8d7a-7eba2a7f29b0.png",alt:""}})]),t._v(" "),e("p",[t._v("When you run Sanic, the main process instantiates a "),e("code",[t._v("WorkerManager")]),t._v(". That manager is in charge of running one or more "),e("code",[t._v("WorkerProcess")]),t._v(". There generally are two kinds of processes:")]),t._v(" "),e("ul",[e("li",[t._v("server processes, and")]),t._v(" "),e("li",[t._v("non-server processes.")])]),t._v(" "),e("p",[t._v('For the sake of ease, the User Guide generally will use the term "worker" or "worker process" to mean a server process, and "Manager" to mean the single worker manager running in your main process.')]),t._v(" "),e("h2",{attrs:{id:"how-sanic-server-starts-processes"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#how-sanic-server-starts-processes"}},[t._v("#")]),t._v(" How Sanic Server starts processes")]),t._v(" "),e("p",[t._v("Sanic will start processes using the "),e("a",{attrs:{href:"https://docs.python.org/3/library/multiprocessing.html#contexts-and-start-methods",target:"_blank",rel:"noopener noreferrer"}},[t._v("spawn"),e("OutboundLink")],1),t._v(" start method. This means that for every process/worker, the global scope of your application will be run on its own thread. The practical impact of this that "),e("em",[t._v("if")]),t._v(" you do not run Sanic with the CLI, you will need to nest the execution code inside a block to make sure it only runs on "),e("code",[t._v("__main__")]),t._v(".")]),t._v(" "),e("div",{staticClass:"language-python extra-class"},[e("pre",{pre:!0,attrs:{class:"language-python"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" __name__ "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"__main__"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    app"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("run"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),e("p",[t._v("If you do not, you are likely to see an error message like this:")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v('sanic.exceptions.ServerError: Sanic server could not start: [Errno 98] Address already in use.\n\nThis may have happened if you are running Sanic in the global scope and not inside of a `if __name__ == "__main__"` block.\n\nSee more information: https://sanic.dev/en/guide/deployment/manager.html#how-sanic-server-starts-processes\n')])])]),e("p",[t._v("The likely fix for this problem is nesting your Sanic run call inside of the "),e("code",[t._v('__name__ == "__main__"')]),t._v(" block. If you continue to receive this message after nesting, or if you see this while using the CLI, then it means the port you are trying to use is not available on your machine and you must select another port.")]),t._v(" "),e("h3",{attrs:{id:"starting-a-worker"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#starting-a-worker"}},[t._v("#")]),t._v(" Starting a worker")]),t._v(" "),e("p",[t._v("All worker processes "),e("em",[t._v("must")]),t._v(" send an acknowledgement when starting. This happens under the hood, and you as a developer do not need to do anything. However, the Manager will exit with a status code "),e("code",[t._v("1")]),t._v(" if one or more workers do not send that "),e("code",[t._v("ack")]),t._v(" message, or a worker process throws an exception while trying to start. If no exceptions are encountered, the Manager will wait for up to thirty (30) seconds for the acknowledgement.")]),t._v(" "),e("div",{staticClass:"multicolumn",staticStyle:{display:"flex","flex-direction":"row","align-items":"flex-start"}},[e("div",{staticClass:"multicolumn-column",staticStyle:{"flex-grow":"1","flex-basis":"0"}},[e("p",[t._v("In the situation when you know that you will need more time to start, you can monkeypatch the Manager. The threshold does not include anything inside of a listener, and is limited to the execution time of everything in the global scope of your application.")]),t._v(" "),e("p",[t._v("If you run into this issue, it may indicate a need to look deeper into what is causing the slow startup.")])]),t._v(" "),e("div",{staticClass:"multicolumn-column",staticStyle:{"flex-grow":"1","flex-basis":"0"}},[e("div",{staticClass:"language-python extra-class"},[e("pre",{pre:!0,attrs:{class:"language-python"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" sanic"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("worker"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("manager "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" WorkerManager\n\nWorkerManager"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("THRESHOLD "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),t._v("  "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Value is in 0.1s")]),t._v("\n")])])])])]),t._v(" "),e("p",[t._v("See "),e("a",{attrs:{href:"#worker-ack"}},[t._v("worker ack")]),t._v(" for more information.")]),t._v(" "),e("div",{staticClass:"multicolumn",staticStyle:{display:"flex","flex-direction":"row","align-items":"flex-start"}},[e("div",{staticClass:"multicolumn-column",staticStyle:{"flex-grow":"1","flex-basis":"0"}},[e("p",[t._v("As stated above, Sanic will use "),e("a",{attrs:{href:"https://docs.python.org/3/library/multiprocessing.html#contexts-and-start-methods",target:"_blank",rel:"noopener noreferrer"}},[t._v("spawn"),e("OutboundLink")],1),t._v(" to start worker processes. If you would like to change this behavior and are aware of the implications of using different start methods, you can modify as shown here.")])]),t._v(" "),e("div",{staticClass:"multicolumn-column",staticStyle:{"flex-grow":"1","flex-basis":"0"}},[e("div",{staticClass:"language-python extra-class"},[e("pre",{pre:!0,attrs:{class:"language-python"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" sanic "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" Sanic\n\nSanic"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("start_method "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"fork"')]),t._v("\n")])])])])]),t._v(" "),e("h3",{attrs:{id:"worker-ack"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#worker-ack"}},[t._v("#")]),t._v(" Worker ack")]),t._v(" "),e("p",[t._v("When all of your workers are running in a subprocess a potential problem is created: deadlock. This can occur when the child processes cease to function, but the main process is unaware that this happened. Therefore, Sanic servers will automatically send an "),e("code",[t._v("ack")]),t._v(" message (short for acknowledge) to the main process after startup.")]),t._v(" "),e("p",[t._v("In version 22.9, the "),e("code",[t._v("ack")]),t._v(" timeout was short and limited to "),e("code",[t._v("5s")]),t._v(". In version 22.12, the timeout was lengthened to "),e("code",[t._v("30s")]),t._v(". If your application is shutting down after thirty seconds then it might be necessary to manually increase this threshhold.")]),t._v(" "),e("div",{staticClass:"multicolumn",staticStyle:{display:"flex","flex-direction":"row","align-items":"flex-start"}},[e("div",{staticClass:"multicolumn-column",staticStyle:{"flex-grow":"1","flex-basis":"0"}},[e("p",[t._v("The value of "),e("code",[t._v("WorkerManager.THRESHOLD")]),t._v(" is in "),e("code",[t._v("0.1s")]),t._v(" increments. Therefore, to set it to one minute, you should set the value to "),e("code",[t._v("600")]),t._v(".")]),t._v(" "),e("p",[t._v("This value should be set as early as possible in your application, and should ideally happen in the global scope.  Setting it after the main process has started will not work.")])]),t._v(" "),e("div",{staticClass:"multicolumn-column",staticStyle:{"flex-grow":"1","flex-basis":"0"}},[e("div",{staticClass:"language-python extra-class"},[e("pre",{pre:!0,attrs:{class:"language-python"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" sanic"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("worker"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("manager "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" WorkerManager\n\nWorkerManager"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("THRESHOLD "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("600")]),t._v("\n")])])])])]),t._v(" "),e("h3",{attrs:{id:"zero-downtime-restarts"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#zero-downtime-restarts"}},[t._v("#")]),t._v(" Zero downtime restarts")]),t._v(" "),e("p",[t._v("By default, when restarting workers, Sanic will teardown the existing process first before starting a new one.")]),t._v(" "),e("p",[t._v("If you are intending to use the restart functionality in production then you may be interested in having zero-downtime reloading. This can be accomplished by forcing the reloader to change the order to start a new process, wait for it to "),e("a",{attrs:{href:"#worker-ack"}},[t._v("ack")]),t._v(", and then teardown the old process.")]),t._v(" "),e("div",{staticClass:"multicolumn",staticStyle:{display:"flex","flex-direction":"row","align-items":"flex-start"}},[e("div",{staticClass:"multicolumn-column",staticStyle:{"flex-grow":"1","flex-basis":"0"}},[e("p",[t._v("From the multiplexer, use the "),e("code",[t._v("zero_downtime")]),t._v(" argument")])]),t._v(" "),e("div",{staticClass:"multicolumn-column",staticStyle:{"flex-grow":"1","flex-basis":"0"}},[e("div",{staticClass:"language-python extra-class"},[e("pre",{pre:!0,attrs:{class:"language-python"}},[e("code",[t._v("app"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("m"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("restart"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("zero_downtime"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("True")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])])])]),t._v(" "),e("p",[e("em",[t._v("Added in v22.12")])]),t._v(" "),e("h2",{attrs:{id:"using-shared-context-between-worker-processes"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#using-shared-context-between-worker-processes"}},[t._v("#")]),t._v(" Using shared context between worker processes")]),t._v(" "),e("p",[t._v("Python provides a few methods for "),e("a",{attrs:{href:"https://docs.python.org/3/library/multiprocessing.html#exchanging-objects-between-processes",target:"_blank",rel:"noopener noreferrer"}},[t._v("exchanging objects"),e("OutboundLink")],1),t._v(", "),e("a",{attrs:{href:"https://docs.python.org/3/library/multiprocessing.html#synchronization-between-processes",target:"_blank",rel:"noopener noreferrer"}},[t._v("synchronizing"),e("OutboundLink")],1),t._v(", and "),e("a",{attrs:{href:"https://docs.python.org/3/library/multiprocessing.html#sharing-state-between-processes",target:"_blank",rel:"noopener noreferrer"}},[t._v("sharing state"),e("OutboundLink")],1),t._v(" between processes. This usually involves objects from the "),e("code",[t._v("multiprocessing")]),t._v(" and "),e("code",[t._v("ctypes")]),t._v(" modules.")]),t._v(" "),e("p",[t._v("If you are familiar with these objects and how to work with them, you will be happy to know that Sanic provides an API for sharing these objects between your worker processes. If you are not familiar, you are encouraged to read through the Python documentation linked above and try some of the examples before proceeding with implementing shared context.")]),t._v(" "),e("p",[t._v("Similar to how "),e("RouterLink",{attrs:{to:"/en/guide/basics/app.html#application-context"}},[t._v("application context")]),t._v(" allows an applicaiton to share state across the lifetime of the application with "),e("code",[t._v("app.ctx")]),t._v(", shared context provides the same for the special objects mentioned above. This context is available as "),e("code",[t._v("app.shared_ctx")]),t._v(" and should "),e("strong",[t._v("ONLY")]),t._v(" be used to share objects intended for this purpose.")],1),t._v(" "),e("p",[t._v("The "),e("code",[t._v("shared_ctx")]),t._v(" will:")]),t._v(" "),e("ul",[e("li",[e("em",[t._v("NOT")]),t._v(" share regular objects like "),e("code",[t._v("int")]),t._v(", "),e("code",[t._v("dict")]),t._v(", or "),e("code",[t._v("list")])]),t._v(" "),e("li",[e("em",[t._v("NOT")]),t._v(" share state between Sanic instances running on different machines")]),t._v(" "),e("li",[e("em",[t._v("NOT")]),t._v(" share state to non-worker processes")]),t._v(" "),e("li",[e("strong",[t._v("only")]),t._v(" share state between server workers managed by the same Manager")])]),t._v(" "),e("p",[t._v("Attaching an inappropriate object to "),e("code",[t._v("shared_ctx")]),t._v(" will likely result in a warning, and not an error. You should be careful to not accidentally add an unsafe object to "),e("code",[t._v("shared_ctx")]),t._v(" as it may not work as expected. If you are directed here because of one of those warnings, you might have accidentally used an unsafe object in "),e("code",[t._v("shared_ctx")]),t._v(".")]),t._v(" "),e("div",{staticClass:"multicolumn",staticStyle:{display:"flex","flex-direction":"row","align-items":"flex-start"}},[e("div",{staticClass:"multicolumn-column",staticStyle:{"flex-grow":"1","flex-basis":"0"}},[e("p",[t._v("In order to create a shared object you "),e("strong",[t._v("must")]),t._v(" create it in the main process and attach it inside of the "),e("code",[t._v("main_process_start")]),t._v(" listener.")])]),t._v(" "),e("div",{staticClass:"multicolumn-column",staticStyle:{"flex-grow":"1","flex-basis":"0"}},[e("div",{staticClass:"language-python extra-class"},[e("pre",{pre:!0,attrs:{class:"language-python"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" multiprocessing "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" Queue\n\n"),e("span",{pre:!0,attrs:{class:"token decorator annotation punctuation"}},[t._v("@app"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("main_process_start")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("main_process_start")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("app"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    app"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("shared_ctx"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("queue "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Queue"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])])])]),t._v(" "),e("p",[t._v("Trying to attach to the "),e("code",[t._v("shared_ctx")]),t._v(" object outside of this listener may result in a "),e("code",[t._v("RuntimeError")]),t._v(".")]),t._v(" "),e("div",{staticClass:"multicolumn",staticStyle:{display:"flex","flex-direction":"row","align-items":"flex-start"}},[e("div",{staticClass:"multicolumn-column",staticStyle:{"flex-grow":"1","flex-basis":"0"}},[e("p",[t._v("After creating the objects in the "),e("code",[t._v("main_process_start")]),t._v(" listener and attaching to the "),e("code",[t._v("shared_ctx")]),t._v(", they will be available in your workers wherever the application instance is available (example: listeners, middleware, request handlers).")])]),t._v(" "),e("div",{staticClass:"multicolumn-column",staticStyle:{"flex-grow":"1","flex-basis":"0"}},[e("div",{staticClass:"language-python extra-class"},[e("pre",{pre:!0,attrs:{class:"language-python"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" multiprocessing "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" Queue\n\n"),e("span",{pre:!0,attrs:{class:"token decorator annotation punctuation"}},[t._v("@app"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("get")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("handler")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("request"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    request"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("app"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("shared_ctx"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("queue"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("put"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n")])])])])]),t._v(" "),e("h2",{attrs:{id:"access-to-the-multiplexer"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#access-to-the-multiplexer"}},[t._v("#")]),t._v(" Access to the multiplexer")]),t._v(" "),e("p",[t._v("The application instance has access to an object that provides access to interacting with the Manager and other worker processes. The object is attached as the "),e("code",[t._v("app.multiplexer")]),t._v(" property, but it is more easily accessed by its alias: "),e("code",[t._v("app.m")]),t._v(".")]),t._v(" "),e("div",{staticClass:"multicolumn",staticStyle:{display:"flex","flex-direction":"row","align-items":"flex-start"}},[e("div",{staticClass:"multicolumn-column",staticStyle:{"flex-grow":"1","flex-basis":"0"}},[e("p",[t._v("For example, you can get access to the current worker state.")])]),t._v(" "),e("div",{staticClass:"multicolumn-column",staticStyle:{"flex-grow":"1","flex-basis":"0"}},[e("div",{staticClass:"language-python extra-class"},[e("pre",{pre:!0,attrs:{class:"language-python"}},[e("code",[e("span",{pre:!0,attrs:{class:"token decorator annotation punctuation"}},[t._v("@app"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("on_request")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("print_state")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("request"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Request"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("print")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("request"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("app"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("m"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("name"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("print")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("request"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("app"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("m"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("pid"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("print")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("request"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("app"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("m"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("state"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("Sanic-Server-0-0\n99999\n{'server': True, 'state': 'ACKED', 'pid': 99999, 'start_at': datetime.datetime(2022, 10, 1, 0, 0, 0, 0, tzinfo=datetime.timezone.utc), 'starts': 2, 'restart_at': datetime.datetime(2022, 10, 1, 0, 0, 12, 861332, tzinfo=datetime.timezone.utc)}\n")])])])])]),t._v(" "),e("div",{staticClass:"multicolumn",staticStyle:{display:"flex","flex-direction":"row","align-items":"flex-start"}},[e("div",{staticClass:"multicolumn-column",staticStyle:{"flex-grow":"1","flex-basis":"0"}},[e("p",[t._v("The "),e("code",[t._v("multiplexer")]),t._v(" also has access to terminate the Manager, or restart worker processes")])]),t._v(" "),e("div",{staticClass:"multicolumn-column",staticStyle:{"flex-grow":"1","flex-basis":"0"}},[e("div",{staticClass:"language-python extra-class"},[e("pre",{pre:!0,attrs:{class:"language-python"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# shutdown the entire application and all processes")]),t._v("\napp"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("m"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("name"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("terminate"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# restart the current worker only")]),t._v("\napp"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("m"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("name"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("restart"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# restart specific workers only (comma delimited)")]),t._v("\napp"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("m"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("name"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("restart"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Sanic-Server-4-0,Sanic-Server-7-0"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# restart ALL workers")]),t._v("\napp"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("m"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("name"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("restart"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("all_workers"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("True")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("  "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Available v22.12+")]),t._v("\n")])])])])]),t._v(" "),e("h2",{attrs:{id:"worker-state"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#worker-state"}},[t._v("#")]),t._v(" Worker state")]),t._v(" "),e("div",{staticClass:"multicolumn",staticStyle:{display:"flex","flex-direction":"row","align-items":"flex-start"}},[e("div",{staticClass:"multicolumn-column",staticStyle:{"flex-grow":"1","flex-basis":"0"}},[e("p",[t._v("As shown above, the "),e("code",[t._v("multiplexer")]),t._v(" has access to report upon the state of the current running worker. However, it also contains the state for ALL processes running.")])]),t._v(" "),e("div",{staticClass:"multicolumn-column",staticStyle:{"flex-grow":"1","flex-basis":"0"}},[e("div",{staticClass:"language-python extra-class"},[e("pre",{pre:!0,attrs:{class:"language-python"}},[e("code",[e("span",{pre:!0,attrs:{class:"token decorator annotation punctuation"}},[t._v("@app"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("on_request")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("print_state")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("request"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Request"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("print")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("request"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("app"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("m"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("workers"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("{\n    'Sanic-Main': {'pid': 99997},\n    'Sanic-Server-0-0': {\n        'server': True,\n        'state': 'ACKED',\n        'pid': 9999,\n        'start_at': datetime.datetime(2022, 10, 1, 0, 0, 0, 0, tzinfo=datetime.timezone.utc),\n        'starts': 2,\n        'restart_at': datetime.datetime(2022, 10, 1, 0, 0, 12, 861332, tzinfo=datetime.timezone.utc)\n    },\n    'Sanic-Reloader-0': {\n        'server': False,\n        'state': 'STARTED',\n        'pid': 99998,\n        'start_at': datetime.datetime(2022, 10, 1, 0, 0, 0, 0, tzinfo=datetime.timezone.utc),\n        'starts': 1\n    }\n}\n")])])])])]),t._v(" "),e("h2",{attrs:{id:"built-in-non-server-processes"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#built-in-non-server-processes"}},[t._v("#")]),t._v(" Built-in non-server processes")]),t._v(" "),e("p",[t._v("As mentioned, the Manager also has the ability to run non-server processes. Sanic comes with two built-in types of non-server processes, and allows for "),e("a",{attrs:{href:"#running-custom-processes"}},[t._v("creating custom processes")]),t._v(".")]),t._v(" "),e("p",[t._v("The two built-in processes are")]),t._v(" "),e("ul",[e("li",[t._v("the "),e("RouterLink",{attrs:{to:"/en/guide/deployment/development.html#automatic-reloader"}},[t._v("auto-reloader")]),t._v(", optionally enabled to watch the file system for changes and trigger a restart")],1),t._v(" "),e("li",[e("a",{attrs:{href:"#inspector"}},[t._v("inspector")]),t._v(", optionally enabled to provide external access to the state of the running instance")])]),t._v(" "),e("h2",{attrs:{id:"inspector"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#inspector"}},[t._v("#")]),t._v(" Inspector")]),t._v(" "),e("p",[t._v("Sanic has the ability to expose the state and the functionality of the "),e("code",[t._v("multiplexer")]),t._v(" to the CLI. Currently, this requires the CLI command to be run on the same machine as the running Sanic instance. By default the inspector is disabled.")]),t._v(" "),e("div",{staticClass:"multicolumn",staticStyle:{display:"flex","flex-direction":"row","align-items":"flex-start"}},[e("div",{staticClass:"multicolumn-column",staticStyle:{"flex-grow":"1","flex-basis":"0"}},[e("p",[t._v("To enable it, set the config value to "),e("code",[t._v("True")]),t._v(".")])]),t._v(" "),e("div",{staticClass:"multicolumn-column",staticStyle:{"flex-grow":"1","flex-basis":"0"}},[e("div",{staticClass:"language-python extra-class"},[e("pre",{pre:!0,attrs:{class:"language-python"}},[e("code",[t._v("app"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("config"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("INSPECTOR "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("True")]),t._v("\n")])])])])]),t._v(" "),e("p",[t._v("You will now have access to execute any of these CLI commands:")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("sanic inspect reload                      Trigger a reload of the server workers\nsanic inspect shutdown                    Shutdown the application and all processes\nsanic inspect scale N                     Scale the number of workers to N\nsanic inspect <custom>                    Run a custom command\n")])])]),e("p",[e("img",{attrs:{src:"https://user-images.githubusercontent.com/166269/190099384-2f2f3fae-22d5-4529-b279-8446f6b5f9bd.png",alt:""}})]),t._v(" "),e("div",{staticClass:"multicolumn",staticStyle:{display:"flex","flex-direction":"row","align-items":"flex-start"}},[e("div",{staticClass:"multicolumn-column",staticStyle:{"flex-grow":"1","flex-basis":"0"}},[e("p",[t._v("This works by exposing a small HTTP service on your machine. You can control the location using configuration values:")])]),t._v(" "),e("div",{staticClass:"multicolumn-column",staticStyle:{"flex-grow":"1","flex-basis":"0"}},[e("div",{staticClass:"language-python extra-class"},[e("pre",{pre:!0,attrs:{class:"language-python"}},[e("code",[t._v("app"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("config"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("INSPECTOR_HOST "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("  "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"localhost"')]),t._v("\napp"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("config"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("INSPECTOR_PORT "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("  "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("6457")]),t._v("\n")])])])])]),t._v(" "),e("p",[e("RouterLink",{attrs:{to:"/en/guide/deployment/inspector.html"}},[t._v("Learn more")]),t._v(" to find out what is possible with the Inspector.")],1),t._v(" "),e("h2",{attrs:{id:"running-custom-processes"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#running-custom-processes"}},[t._v("#")]),t._v(" Running custom processes")]),t._v(" "),e("p",[t._v("To run a managed custom process on Sanic, you must create a callable. If that process is meant to be long-running, then it should handle a shutdown call by a "),e("code",[t._v("SIGINT")]),t._v(" or "),e("code",[t._v("SIGTERM")]),t._v(" signal.")]),t._v(" "),e("div",{staticClass:"multicolumn",staticStyle:{display:"flex","flex-direction":"row","align-items":"flex-start"}},[e("div",{staticClass:"multicolumn-column",staticStyle:{"flex-grow":"1","flex-basis":"0"}},[e("p",[t._v("The simplest method for doing that in Python will be to just wrap your loop in "),e("code",[t._v("KeyboardInterrupt")]),t._v(".")]),t._v(" "),e("p",[t._v("If you intend to run another application, like a bot, then it is likely that it already has capability to handle this signal and you likely do not need to do anything.")])]),t._v(" "),e("div",{staticClass:"multicolumn-column",staticStyle:{"flex-grow":"1","flex-basis":"0"}},[e("div",{staticClass:"language-python extra-class"},[e("pre",{pre:!0,attrs:{class:"language-python"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" time "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" sleep\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("my_process")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("foo"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("try")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("while")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("True")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n            sleep"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("except")]),t._v(" KeyboardInterrupt"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("print")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"done"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])])])]),t._v(" "),e("div",{staticClass:"multicolumn",staticStyle:{display:"flex","flex-direction":"row","align-items":"flex-start"}},[e("div",{staticClass:"multicolumn-column",staticStyle:{"flex-grow":"1","flex-basis":"0"}},[e("p",[t._v("That callable must be registered in the "),e("code",[t._v("main_process_ready")]),t._v(" listener. It is important to note that is is "),e("strong",[t._v("NOT")]),t._v(" the same location that you should register "),e("a",{attrs:{href:"#using-shared-context-between-worker-processes"}},[t._v("shared context")]),t._v(" objects.")])]),t._v(" "),e("div",{staticClass:"multicolumn-column",staticStyle:{"flex-grow":"1","flex-basis":"0"}},[e("div",{staticClass:"language-python extra-class"},[e("pre",{pre:!0,attrs:{class:"language-python"}},[e("code",[e("span",{pre:!0,attrs:{class:"token decorator annotation punctuation"}},[t._v("@app"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("main_process_ready")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("ready")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("app"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Sanic"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" _"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#   app.manager.manage(<name>, <callable>, <kwargs>)")]),t._v("\n    app"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("manager"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("manage"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"MyProcess"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" my_process"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"foo"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"bar"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])])])]),t._v(" "),e("h2",{attrs:{id:"single-process-mode"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#single-process-mode"}},[t._v("#")]),t._v(" Single process mode")]),t._v(" "),e("div",{staticClass:"multicolumn",staticStyle:{display:"flex","flex-direction":"row","align-items":"flex-start"}},[e("div",{staticClass:"multicolumn-column",staticStyle:{"flex-grow":"1","flex-basis":"0"}},[e("p",[t._v("If you would like to opt out of running multiple processes, you can run Sanic in a single process only. In this case, the Manager will not run. You will also not have access to any features that require processes (auto-reload, the inspector, etc).")])]),t._v(" "),e("div",{staticClass:"multicolumn-column",staticStyle:{"flex-grow":"1","flex-basis":"0"}},[e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[t._v("sanic path.to.server:app --single-process\n")])])]),e("div",{staticClass:"language-python extra-class"},[e("pre",{pre:!0,attrs:{class:"language-python"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" __name__ "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"__main__"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    app"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("run"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("single_process"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("True")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),e("div",{staticClass:"language-python extra-class"},[e("pre",{pre:!0,attrs:{class:"language-python"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" __name__ "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"__main__"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    app"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("prepare"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("single_process"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("True")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    Sanic"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("serve_single"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])])])])])}),[],!1,null,null,null);e.default=n.exports}}]);