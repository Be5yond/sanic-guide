(window.webpackJsonp=window.webpackJsonp||[]).push([[70],{389:function(t,a,e){"use strict";e.r(a);var s=e(5),n=Object(s.a)({},(function(){var t=this,a=t._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"caddy-deployment"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#caddy-deployment"}},[t._v("#")]),t._v(" Caddy Deployment")]),t._v(" "),a("h2",{attrs:{id:"introduction"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#introduction"}},[t._v("#")]),t._v(" Introduction")]),t._v(" "),a("p",[t._v("Caddy is a state-of-the-art web server and proxy that supports up to HTTP/3. Its simplicity lies in its minimalistic configuration and the inbuilt ability to automatically procure TLS certificates for your domains from Let's Encrypt. In this setup, we will configure the Sanic application to serve locally at 127.0.0.1:8001, with Caddy playing the role of the public-facing server for the domain example.com.")]),t._v(" "),a("p",[t._v("You may install Caddy from your favorite package menager on Windows, Linux and Mac. The package is named "),a("code",[t._v("caddy")]),t._v(".")]),t._v(" "),a("h2",{attrs:{id:"proxied-sanic-app"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#proxied-sanic-app"}},[t._v("#")]),t._v(" Proxied Sanic app")]),t._v(" "),a("div",{staticClass:"language-python extra-class"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" sanic "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" Sanic\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" sanic"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("response "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" text\n\napp "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Sanic"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"proxied_example"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token decorator annotation punctuation"}},[t._v("@app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("get")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("index")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("request"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# This should display external (public) addresses:")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" text"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token string-interpolation"}},[a("span",{pre:!0,attrs:{class:"token string"}},[t._v('f"')]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("request"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("remote_addr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v(" connected to ")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("request"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("url_for"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'index'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('\\n"')])]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token string-interpolation"}},[a("span",{pre:!0,attrs:{class:"token string"}},[t._v('f"Forwarded: ')]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("request"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("forwarded"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('\\n"')])]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),a("p",[t._v("To run this application, save as "),a("code",[t._v("proxied_example.py")]),t._v(", and use the sanic command-line interface as follows:")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("SANIC_PROXIES_COUNT")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" sanic proxied_example "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--port")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8001")]),t._v("\n")])])]),a("p",[t._v("Setting the SANIC_PROXIES_COUNT environment variable instructs Sanic to trust the X-Forwarded-* headers sent by Caddy, allowing it to correctly identify the client's IP address and other information.")]),t._v(" "),a("h2",{attrs:{id:"caddy-is-simple"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#caddy-is-simple"}},[t._v("#")]),t._v(" Caddy is simple")]),t._v(" "),a("p",[t._v("If you have no other web servers running, you can simply run Caddy CLI (needs "),a("code",[t._v("sudo")]),t._v(" on Linux):")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("caddy reverse-proxy "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--from")]),t._v(" example.com "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--to")]),t._v(" :8001\n")])])]),a("p",[t._v("This is a complete server that includes a certificate for your domain, http-to-https redirect, proxy headers, streaming and WebSockets. Your Sanic application should now be available on the domain you specified by HTTP versions 1, 2 and 3. Remember to open up UDP/443 on your firewall to enable H3 communications.")]),t._v(" "),a("p",[t._v("All done?")]),t._v(" "),a("p",[t._v("Soon enough you'll be needing more than one server, or more control over details, which is where the configuration files come in. The above command is equivalent to this "),a("code",[t._v("Caddyfile")]),t._v(", serving as a good starting point for your install:")]),t._v(" "),a("div",{staticClass:"language-caddy extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("example.com {\n    reverse_proxy localhost:8001\n}\n")])])]),a("p",[t._v("Some Linux distributions install Caddy such that it reads configuration from "),a("code",[t._v("/etc/caddy/Caddyfile")]),t._v(", which "),a("code",[t._v("import /etc/caddy/conf.d/*")]),t._v(" for each site you are running. If not, you'll need to manually run "),a("code",[t._v("caddy run")]),t._v(" as a system service, pointing it at the proper config file. Alternatively, use Caddy API mode with "),a("code",[t._v("caddy run --resume")]),t._v(" for persistent config changes. Note that any Caddyfile loading will replace all prior configuration and thus "),a("code",[t._v("caddy-api")]),t._v(" is not configurable in this traditional manner.")]),t._v(" "),a("h2",{attrs:{id:"advanced-configuration"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#advanced-configuration"}},[t._v("#")]),t._v(" Advanced configuration")]),t._v(" "),a("p",[t._v("At times, you might need to mix static files and handlers at the site root for cleaner URLs. In Sanic, you'd use "),a("code",[t._v('app.static("/", "static", index="index.html")')]),t._v(" to achieve this. However, for improved performance, you can offload serving static files to Caddy:")]),t._v(" "),a("div",{staticClass:"language-caddy extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("app.example.com {\n    # Look for static files first, proxy to Sanic if not found\n    route {\n        file_server {\n            root /srv/sanicexample/static\n            precompress br                     # brotli your large scripts and styles\n            pass_thru\n        }\n        reverse_proxy unix//tmp/sanic.socket   # sanic --unix /tmp/sanic.socket\n    }\n}\n")])])]),a("p",[t._v("Please refer to "),a("a",{attrs:{href:"https://caddyserver.com/docs/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Caddy documentation"),a("OutboundLink")],1),t._v(" for more options.")])])}),[],!1,null,null,null);a.default=n.exports}}]);